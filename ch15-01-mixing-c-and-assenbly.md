## C言語とアセンブリ言語の連携

### アセンブリ言語で定義したものをC言語で使う

これが関数と変数を実装したアセンブリ言語のコードです：

```asm
# asm_var と言うグローバル変数を定義して公開することで、それを C言語のコードから利用できるようになる
.data
.global asm_var
asm_var:
.long

# asm_fun() という関数を定義して公開することで、それを C言語のコードから利用できるようになる
.text
.global asm_fun
asm_fun:
    ret;
```

そして C言語のコード：

```C
void asm_fun();
extern int asm_var;

int x;

void
main (void)
{
	asm_fun();
	asm_var++;
}
```

理解すべきポイント：

* アセンブリ言語のコードに、C言語のプログラムから利用することが可能な変数や関数を定義できる。
* アセンブリ言語のコードで、C言語のプログラムから利用できる変数や関数を「公開」すること。
この例では ``.global`` 属性を使用して ``asm_var`` と ``asm_fun()`` を公開している。
* C言語のコードは実際に使用する前に公開されている変数や関数を宣言しておく。
これらの宣言は、通常のヘッダファイルの中でやっていることに似ている。
宣言は C言語のソースファイルか、またはヘッダファイルの中で行う。


### C言語で定義したものをアセンブリ言語で使う

まず C言語のコード：

```C
void
fun(void)
{

}
```

次に、上の関数を呼び出すアセンブリ言語のコード：

```asm
	.text
	.globl	main
main:
	call fun
	ret;
```

理解すべきポイント：

* C言語のコードの中で定義した関数と変数は ``static`` キーワードを使わない限り、自動的に外部に公開される。
従って前述のアセンブリ言語のコードの中で実施したように、一つ一つ明示的に公開する必要はない。
* アセンブリ言語では、たとえアセンブリ言語の中で関数や変数が定義されていたとしても、そのまま関数を呼び出したり変数を利用することができる。

### C言語のコードの中にアセンブリ言語のコードを埋め込む

C言語だけでは解決できないことがいくつかあります。
そのような時はアセンブリ言語を使うことになります。
例えばハードウェアの例外を発生させたいような場合、アセンブリ言語で命令を記述する必要がでてきます。
C言語では（API を利用しない限り）ハードウェアの例外を発生させる命令を提供できません。
そのため別のファイルにアセンブリ言語のコードを用意し、C言語のコードから呼び出します。
C言語には、アセンブリ言語のコードを C言語のコードの中に挿入する機能があります。
これを実現する際は ``asm`` キーワードを使います。

これがサンプルコードです：

```C
int main (void)
{
	asm("int $3");
	return 0;
}
```

この C言語のコードから生成したアセンブリ言語のコードが、こちらです：


```asm
	.text
	.globl	main
	.type	main, @function
main:
	pushl	%ebp
	movl	%esp, %ebp
	int $3
	movl	$0, %eax
	popl	%ebp
	ret
```

---

* [目次](/SUMMARY.md#C言語インターナル)

* [前へ](/ch14-01-memory-allocation-for-structure.md)

* [次へ](/ch16-01-miscellaneous.md)

