## プログラムの構造

簡単な C言語のプログラムの例を使って、実行時にプログラムがメモリの中にロードされた時の状態を見てみることにしましょう。

これが簡単な C言語のプログラムです：

```C
int globalVar;

void main()
{
        globalVar = 10;
}

```

このプログラムで注目したい点が二つあります。
それは「グローバル変数」と「関数」です。
関数には実行できるコードが含まれており、グローバル変数には何かデータが格納されています。
このプログラムが機械語に「翻訳」されてメモリにロードされる時、ランダム・アクセス・メモリ（RAM）の中には「データ（Data）」と「コード（Code）」を格納するための領域がそれぞれ確保されます。

![](images/programstructure.png)

「データ（Data）」の領域にはグローバル変数のために確保された数バイトの領域が含まれ、「コード（Code）」の領域は関数のコードから生成された命令をロードするために確保された数バイトの領域が含まれます。
CPU がこれらの命令を実行し、データを処理します。

次に、このプログラム用に生成した実際のアセンブリ言語のコードを見てみることにしましょう：

```asm
        .comm   globalVar,4,4
        .text
.globl main
        .type   main, @function
main:
        pushl   %ebp
        movl    %esp, %ebp
        movl    $10, globalVar
        popl    %ebp
        ret
```

このコードにコメントを入れたものが、こちらです：

```asm
# これがグローバル変数の宣言
# .comm は初期化していないデータを宣言するための識別子
# アセンブラは .bss セグメントの中に、ここに示したサイズの領域を確保する
        .comm   globalVar,4,4
# .text セグメントは、ここから始まる
        .text
# main という関数名を公開することで、このファイルの外から main 関数を呼び出すことができる
.globl main
        .type   main, @function
# 生成した main 関数のコード
main:
        pushl   %ebp
        movl    %esp, %ebp
        movl    $10, globalVar
        popl    %ebp
        ret
```

### セクションとセグメント

「セクション」は、プログラムのリンク時に必要となる情報を格納したオブジェクト・ファイルの中にある領域を示します。
セクションには、リンカが実行形式のバイナリを生成するために使用するデータが含まれています。
例えば、あるセクションにはプログラムのコードやグローバル変数、再配置テーブルなどを格納することができます。
そして「セグメント」はセクションに似ていますが、これが実際にプログラムを実行する際にメモリに格納される領域です。
実行可能なバイナリにはたくさんのセグメントが含まれており、それらはプログラムを実行する時にローダによってメモリにロードされます。
セクションとセグメントには ``.text`` とか ``.data`` とか ``.bss`` といった名前が付いています。

ここに、C言語のコードからアセンブリ言語のコードを生成する場面でよく使用するセクションやセグメントを例として上げてみました：
* ``.text`` => ここには実行可能な命令が格納される。
* ``.bss`` => ここには初期化されていない（全てのビットが0にセットされている）データが格納される。通常は、初期化されていないスタティック変数とグローバル変数が格納される。プログラムからこのセクションにデータを書き込むことができる。
* ``.data`` => ここには初期化されたグローバル変数が格納される。例えば ``int x = 20;`` とグローバル宣言するとここに格納される。プログラムからこのセクションにデータを書き込むことができる。

``.bss`` と ``.data`` セクションはほぼ同じです。
唯一の違いはプログラムがロードされた時に確保したメモリの初期値です。
``.bss`` セグメントは全てのビットが 0 であり、``.data`` セグメントは C言語のコードで宣言されていた値です。

* ``.rodata`` => ここには読み込み専用のデータが格納される。このセグメントは、プログラムがロードされた時にメモリにロードされ、プログラムからは変更することができない領域である。通常、これは文字列の定数が格納される。

オブジェクト・ファイルや実行可能なファイルには他にもいろいろなセクションが存在しますが、それらの多くはプログラムの実行時にメモリにはロードされません。
例えば ``.debug`` セグメントにはデバッガが必要とする情報しか格納されていません。
また、いくつかのセクションはオブジェクト・モジュールにしか存在せず、あとで別のセクションと結合されるというものもあります。
そのようなものには、例えば ``.common`` セクションがあります。

---

* [目次](/SUMMARY.md#C言語インターナル)

* [前へ](/ch01-01-introduction.md#はじめに)

* [次へ](/ch03-01-stack-and-local-variables.md#スタックとローカル変数)
